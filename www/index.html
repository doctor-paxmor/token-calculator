<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Token Calculator</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="calculator-container">
        <!-- Calculator Display -->
        <div class="calculator-display">
            <div class="history-corner" id="historyLog"></div>
            <div class="main-number" id="mainNumber">0</div>
        </div>
        
        <!-- Status Bar -->
        <div class="status-grid">
            <div class="status-cell">
                <div class="status-label">TOKENS</div>
                <div class="status-number total-color" id="status0">0</div>
            </div>
            <div class="status-cell">
                <div class="status-label">VALUE</div>
                <div class="status-number ready-color" id="status1">0</div>
            </div>
            <div class="status-cell">
                <div class="status-label">UNTAPPED</div>
                <div class="status-number ready-color" id="status2">0</div>
            </div>
            <div class="status-cell">
                <div class="status-label">TAPPED</div>
                <div class="status-number used-color" id="status3">0</div>
            </div>
        </div>
        
        <!-- Button Area -->
        <div class="button-area">
            <!-- Modifiers -->
            <div class="button-group">
                <div style="font-size: 10px; color: #888; margin-bottom: 4px; text-align: center;">TOKEN MULTIPLIERS</div>
                <div class="button-row row-4">
                    <button class="btn toggle-btn" id="doublingToggle" onclick="toggleModifier('doublingSeasons')">
                        Doubling<br>Season
                    </button>
                    <button class="btn toggle-btn" id="parallelToggle" onclick="toggleModifier('parallelLives')">
                        Parallel<br>Lives
                    </button>
                    <button class="btn toggle-btn" id="mondrakToggle" onclick="toggleModifier('mondrak')">
                        Mondrak<br>Glory
                    </button>
                    <button class="btn toggle-btn" id="anointedToggle" onclick="toggleModifier('anointedProcession')">
                        Anointed<br>Procession
                    </button>
                </div>
                <div class="button-row row-4">
                    <button class="btn toggle-btn" id="primalToggle" onclick="toggleModifier('primalVigor')">
                        Primal<br>Vigor
                    </button>
                    <button class="btn toggle-btn" id="plusOneToggle" onclick="adjustManualMultiplier(1)">
                        +1x
                    </button>
                    <button class="btn toggle-btn" id="minusOneToggle" onclick="adjustManualMultiplier(-1)">
                        -1x
                    </button>
                    <button class="btn toggle-btn" id="ojerToggle" onclick="toggleModifier('ojerTaq')">
                        Ojer<br>Taq
                    </button>
                </div>
            </div>
            
            <!-- Main Actions (Dynamic) -->
            <div class="button-group">
                <div class="button-row row-2" id="mainActionRow">
                    <button class="btn primary-btn">Loading...</button>
                </div>
            </div>
            
            <!-- Add/Remove Tokens -->
            <div class="button-group">
                <div style="font-size: 10px; color: #888; margin-bottom: 4px; text-align: center;">ADD/REMOVE TOKENS</div>
                <div class="button-row row-4">
                    <button class="btn success-btn" onclick="addTokensDirect(1)">+1</button>
                    <button class="btn success-btn" onclick="addTokensDirect(5)">+5</button>
                    <button class="btn danger-btn" onclick="removeTokens(1)">-1</button>
                    <button class="btn danger-btn" onclick="removeTokens(5)">-5</button>
                </div>
            </div>
            
            <!-- Tap/Untap Controls -->
            <div class="button-group">
                <div style="font-size: 10px; color: #888; margin-bottom: 4px; text-align: center;">TAP/UNTAP TOKENS</div>
                <div class="button-row row-4">
                    <button class="btn warning-btn" onclick="tapTokens(1)">TAP 1</button>
                    <button class="btn warning-btn" onclick="tapAll()">TAP ALL</button>
                    <button class="btn success-btn" onclick="untapTokens(1)">UNTAP 1</button>
                    <button class="btn success-btn" onclick="untapAll()">UNTAP ALL</button>
                </div>
            </div>
            
            <!-- Abilities (Dynamic) -->
            <div class="button-group">
                <div class="button-row row-3" id="abilityRow">
                    <button class="btn purple-btn">Loading...</button>
                </div>
                
                <div class="commander-info" id="commanderInfo">
                    <span>Loading Commander...</span>
                </div>
            </div>
            
            <!-- Reset & Commander Selection -->
            <div class="button-group">
                <div class="button-row row-1" style="grid-template-columns: 1fr;">
                    <button onclick="resetBattlefield()" class="btn danger-btn">
                        RESET ALL
                    </button>
                </div>
                
                <div class="commander-select-container">

                    <!-- Custom Dropdown -->
                    <div class="custom-select" id="commanderCustomSelect">
                        <div class="custom-select-trigger" id="customSelectTrigger" tabindex="0">
                            <span id="customSelectValue">Choose your commander...</span>
                            <div class="custom-select-arrow">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </div>
                        </div>
                        <div class="custom-select-dropdown" id="customSelectDropdown">
                            <!-- Options will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Dropdown backdrop for mobile -->
                    <div class="dropdown-backdrop" id="dropdownBackdrop"></div>
                    
                    <!-- Hidden original select for compatibility -->
                    <select id="commanderSelect" class="commander-select">
                        <option value="">Choose your commander...</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Commander Art -->
        <div class="commander-art">
            <img id="commanderArt" src="" alt="Commander Art">
        </div>

        <!-- Ad Dismiss Button -->
        <div class="ad-banner" id="adBanner">
            <button class="dismiss-btn" onclick="dismissAd()">‚ùé Hide Ad</button>
        </div>
    </div>

    <!-- Hidden inputs -->
    <input type="checkbox" id="doublingSeasons" style="display: none;">
    <input type="checkbox" id="parallelLives" style="display: none;">
    <input type="checkbox" id="mondrak" style="display: none;">
    <input type="checkbox" id="anointedProcession" style="display: none;">
    <input type="checkbox" id="primalVigor" style="display: none;">
    <input type="checkbox" id="ojerTaq" style="display: none;">
    <input type="number" id="manualMultiplier" value="0" style="display: none;">

    <!-- Load Scripts -->
    <script src="js/core.js"></script>
    <script src="js/tokenLogic.js"></script>
    <script src="js/ui.js"></script>
    <script>
        // Custom dropdown functionality
        function initializeCustomDropdown() {
            const customSelect = document.getElementById('commanderCustomSelect');
            const trigger = document.getElementById('customSelectTrigger');
            const dropdown = document.getElementById('customSelectDropdown');
            const valueDisplay = document.getElementById('customSelectValue');
            const originalSelect = document.getElementById('commanderSelect');
            const backdrop = document.getElementById('dropdownBackdrop');

            // Smart positioning - check if dropdown would go off screen
            function checkPosition() {
                const rect = trigger.getBoundingClientRect();
                const dropdownHeight = 240; // max-height of dropdown
                const viewportHeight = window.innerHeight;
                const spaceBelow = viewportHeight - rect.bottom;
                const spaceAbove = rect.top;

                // If not enough space below but enough above, flip up
                if (spaceBelow < dropdownHeight && spaceAbove > dropdownHeight) {
                    customSelect.classList.add('flip-up');
                } else {
                    customSelect.classList.remove('flip-up');
                }
            }

            // Toggle dropdown open/close
            function toggleDropdown() {
                const isOpen = customSelect.classList.contains('open');
                
                if (isOpen) {
                    closeDropdown();
                } else {
                    checkPosition();
                    customSelect.classList.add('open');
                    backdrop.classList.add('active');
                }
            }

            // Close dropdown
            function closeDropdown() {
                customSelect.classList.remove('open');
                backdrop.classList.remove('active');
            }

            // Select option
            function selectOption(value, text) {
                valueDisplay.textContent = text;
                originalSelect.value = value;
                closeDropdown();
                
                // Update game state
                if (value !== gameState.currentCommander) {
                    gameState.currentCommander = value;
                    gameState.commanderCounters = 0;
                    gameState.commanderHasTrample = false;
                    applyCommanderConfig();
                }
            }

            // Populate dropdown options (NO placeholder option)
            function populateDropdown() {
                dropdown.innerHTML = '';
                
                // Only add actual commander options (skip the placeholder)
                originalSelect.querySelectorAll('option[value]:not([value=""])').forEach(option => {
                    const customOption = document.createElement('div');
                    customOption.className = 'custom-select-option';
                    customOption.textContent = option.textContent;
                    customOption.onclick = () => selectOption(option.value, option.textContent);
                    
                    if (option.value === gameState.currentCommander) {
                        customOption.classList.add('selected');
                        valueDisplay.textContent = option.textContent;
                    }
                    
                    dropdown.appendChild(customOption);
                });
            }

            // Event listeners
            trigger.addEventListener('click', toggleDropdown);
            trigger.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleDropdown();
                }
            });

            // Close dropdown when clicking backdrop or outside
            backdrop.addEventListener('click', closeDropdown);
            document.addEventListener('click', (e) => {
                if (!customSelect.contains(e.target)) {
                    closeDropdown();
                }
            });

            // Close on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeDropdown();
                }
            });

            // Reposition on window resize/orientation change
            window.addEventListener('resize', () => {
                if (customSelect.classList.contains('open')) {
                    checkPosition();
                }
            });

            // Initialize
            populateDropdown();

            // Update when original select changes
            originalSelect.addEventListener('change', populateDropdown);
        }

        // Initialize app when everything loads
        document.addEventListener('DOMContentLoaded', async function() {
            await loadAvailableCommanders();
            initializeCustomDropdown();
            initializeApp();
        });
    </script>
</body>
</html>